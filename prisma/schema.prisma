generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String              @id
  email                   String              @unique
  name                    String
  password                String?
  role                    UserRole            @default(STUDENT)
  avatar                  String?
  bio                     String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  lastLoginAt             DateTime?
  stripeCustomerId        String?             @unique
  stripeSubscriptionId    String?             @unique
  stripePriceId           String?
  stripeCurrentPeriodEnd  DateTime?
  subscriptionStatus      SubscriptionStatus  @default(FREE)
  aiInsights              AIInsight[]
  answers                 Answer[]
  learningPath            LearningPath?
  learningPattern         LearningPattern?
  performanceSummary      PerformanceSummary?
  progress                Progress[]
  reviewHistory           ReviewHistory[]
  notes                   StudyNote[]
  tests                   Test[]
  testSessions            TestSession[]
  userInteractions        UserInteraction[]

  @@index([email])
  @@index([createdAt])
  @@index([stripeCustomerId])
  @@index([subscriptionStatus])
}

model System {
  id            String     @id @default(cuid())
  name          String     @unique
  description   String?
  displayOrder  Int
  icon          String?
  questionCount Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  progress      Progress[] @relation("SystemProgress")
  questions     Question[] @relation("SystemQuestions")
  topics        Topic[]

  @@index([displayOrder])
}

model Topic {
  id            String     @id @default(cuid())
  name          String
  systemId      String
  description   String?
  displayOrder  Int
  questionCount Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  progress      Progress[] @relation("TopicProgress")
  questions     Question[] @relation("TopicQuestions")
  system        System     @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([systemId, name])
  @@index([systemId])
  @@index([displayOrder])
}

model Subject {
  id            String     @id @default(cuid())
  name          String     @unique
  description   String?
  displayOrder  Int
  questionCount Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  progress      Progress[] @relation("SubjectProgress")
  questions     Question[] @relation("SubjectQuestions")

  @@index([displayOrder])
}

model Question {
  id              String            @id @default(cuid())
  text            String
  explanation     String?
  difficulty      DifficultyLevel   @default(MEDIUM)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  systemId        String?
  topicId         String?
  subjectId       String?
  totalAttempts   Int               @default(0)
  correctAttempts Int               @default(0)
  successRate     Float             @default(0)
  avgTimeSpent    Int               @default(0)
  answers         Answer[]
  options         AnswerOption[]
  subject         Subject?          @relation("SubjectQuestions", fields: [subjectId], references: [id])
  system          System?           @relation("SystemQuestions", fields: [systemId], references: [id])
  topic           Topic?            @relation("TopicQuestions", fields: [topicId], references: [id])
  inTests         TestQuestion[]
  interactions    UserInteraction[]

  @@index([systemId])
  @@index([topicId])
  @@index([subjectId])
  @@index([difficulty])
}

model AnswerOption {
  id                String   @id @default(cuid())
  questionId        String
  text              String
  isCorrect         Boolean  @default(false)
  displayOrder      Int
  createdAt         DateTime @default(now())
  selectedByAnswers Answer[]
  question          Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([isCorrect])
}

model Test {
  id                     String             @id @default(cuid())
  userId                 String
  title                  String
  description            String?
  mode                   TestMode           @default(TUTOR)
  questionMode           QuestionMode       @default(STANDARD)
  useAI                  Boolean            @default(false)
  totalQuestions         Int
  timeLimit              Int?
  selectedSubjects       String[]
  selectedTopics         String[]
  score                  Float?
  totalCorrect           Int                @default(0)
  totalIncorrect         Int                @default(0)
  totalSkipped           Int                @default(0)
  startedAt              DateTime?
  completedAt            DateTime?
  duration               Int?
  status                 TestStatus         @default(ACTIVE)
  statusUpdatedAt        DateTime           @default(now())
  sessionToken           String?            @unique
  lastActivityAt         DateTime           @updatedAt
  attemptNumber          Int                @default(1)
  maxAttempts            Int                @default(3)
  completionStatus       String             @default("ACTIVE")
  abandonReason          AbandonReason?
  scoreIncompleteAs      UnansweredHandling @default(SKIPPED)
  applyIncompletePenalty Boolean            @default(false)
  incompletePenalty      Float              @default(0.9)
  answeredCount          Int                @default(0)
  skippedCount           Int                @default(0)
  unansweredCount        Int                @default(0)
  pausedAt               DateTime?
  resumedAt              DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  answers                Answer[]
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions              TestQuestion[]
  sessions               TestSession[]
  interactions           UserInteraction[]

  @@index([userId])
  @@index([status])
  @@index([lastActivityAt])
  @@index([sessionToken])
  @@index([createdAt])
  @@index([completedAt])
}

model TestQuestion {
  id           String   @id @default(cuid())
  testId       String
  questionId   String
  displayOrder Int
  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  test         Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, questionId])
  @@index([testId])
  @@index([questionId])
}

model Answer {
  id               String            @id @default(cuid())
  userId           String
  testId           String
  questionId       String
  selectedOptionId String?
  status           AnswerStatus      @default(NOT_ANSWERED)
  isCorrect        Boolean?
  timeSpent        Int?
  answeredAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  markedForReview  Boolean           @default(false)
  attemptCount     Int               @default(1)
  lastModified     DateTime          @updatedAt
  question         Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption   AnswerOption?     @relation(fields: [selectedOptionId], references: [id])
  test             Test              @relation(fields: [testId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionScore    QuestionScore?
  reviewHistory    ReviewHistory[]
  interactions     UserInteraction[]

  @@unique([testId, questionId])
  @@index([userId])
  @@index([testId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([status])
}

model UserInteraction {
  id         String    @id @default(cuid())
  userId     String
  actionType String
  entityType String
  entityId   String?
  testId     String?
  questionId String?
  answerId   String?
  metadata   String?
  durationMs Int?
  clientIP   String?
  userAgent  String?
  createdAt  DateTime  @default(now())
  answer     Answer?   @relation(fields: [answerId], references: [id])
  question   Question? @relation(fields: [questionId], references: [id])
  test       Test?     @relation(fields: [testId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([entityType])
  @@index([createdAt])
  @@index([testId])
  @@index([questionId])
}

model Progress {
  id                      String    @id @default(cuid())
  userId                  String
  systemId                String?
  topicId                 String?
  subjectId               String?
  masteryLevel            Float     @default(0)
  totalQuestionsAttempted Int       @default(0)
  correctAnswers          Int       @default(0)
  incorrectAnswers        Int       @default(0)
  successRate             Float     @default(0)
  firstAttemptAt          DateTime?
  lastAttemptAt           DateTime?
  subject                 Subject?  @relation("SubjectProgress", fields: [subjectId], references: [id])
  system                  System?   @relation("SystemProgress", fields: [systemId], references: [id])
  topic                   Topic?    @relation("TopicProgress", fields: [topicId], references: [id])
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, systemId, topicId, subjectId])
  @@index([userId])
  @@index([systemId])
  @@index([topicId])
  @@index([subjectId])
}

model StudyNote {
  id         String   @id @default(cuid())
  userId     String
  title      String
  content    String
  tags       String[]
  questionId String?
  systemId   String?
  topicId    String?
  isPinned   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model TestSession {
  id                  String        @id @default(cuid())
  userId              String
  testId              String
  sessionNumber       Int
  sessionToken        String?       @unique
  startedAt           DateTime
  pausedAt            DateTime?
  resumedAt           DateTime?
  endedAt             DateTime?
  deviceType          String?
  browser             String?
  totalEventCount     Int           @default(0)
  focusLostCount      Int           @default(0)
  focusRestoredCount  Int           @default(0)
  disconnectCount     Int           @default(0)
  canResume           Boolean       @default(true)
  resumeDeadline      DateTime?
  resumeAttempts      Int           @default(0)
  maxResumeAttempts   Int           @default(3)
  averageResponseTime Int?
  questionsAnswered   Int           @default(0)
  correctAnswersCount Int           @default(0)
  lastActivity        DateTime      @updatedAt
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  statusEvents        StatusEvent[]
  test                Test          @relation(fields: [testId], references: [id])
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([testId])
  @@index([sessionToken])
  @@index([startedAt])
}

model ReviewHistory {
  id         String   @id @default(cuid())
  userId     String
  answerId   String
  reviewedAt DateTime @default(now())
  confidence Int?
  notes      String?
  answer     Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reviewedAt])
}

model LearningPath {
  id                   String    @id @default(cuid())
  userId               String    @unique
  description          String?
  focusAreas           String[]
  targetMasteryLevel   Float     @default(80)
  startedAt            DateTime  @default(now())
  targetCompletionDate DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserLeaderboard {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  totalTests             Int       @default(0)
  averageScore           Float     @default(0)
  totalQuestionsAnswered Int       @default(0)
  totalCorrectAnswers    Int       @default(0)
  overallSuccessRate     Float     @default(0)
  streakDays             Int       @default(0)
  lastActivityDate       DateTime?
  rank                   Int?
  updatedAt              DateTime  @updatedAt

  @@index([averageScore])
  @@index([rank])
}

model AIInsight {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  content   String
  metadata  Json?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  expiresAt DateTime
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

model PerformanceSummary {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  overallAccuracy        Float     @default(0)
  averageScore           Float     @default(0)
  successRate            Float     @default(0)
  estimatedReadiness     Float     @default(0)
  timePerQuestion        Float     @default(0)
  totalQuestionsAnswered Int       @default(0)
  totalCorrectAnswers    Int       @default(0)
  testsCompleted         Int       @default(0)
  totalStudyTime         Int       @default(0)
  activeDaysCount        Int       @default(0)
  currentStreak          Int       @default(0)
  longestStreak          Int       @default(0)
  dailyGoalMetDays       Int       @default(0)
  optimalStudyTime       String?
  bestDayOfWeek          String?
  globalRank             Int?
  percentileRank         Float?
  friendsRank            Int?
  monthlyGrowthRate      Float     @default(0)
  weeklyGrowthRate       Float     @default(0)
  projectedExamDate      DateTime?
  projectedReadiness     Float?
  subjectMastery         Json?
  topicPerformance       Json?
  updatedAt              DateTime  @updatedAt
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([globalRank])
  @@index([estimatedReadiness])
}

model LearningPattern {
  id                  String   @id @default(cuid())
  userId              String   @unique
  peakPerformanceTime String?
  bestStudyDay        String?
  avgSessionDuration  Int?
  hardQAccuracy       Float    @default(0)
  easyQAccuracy       Float    @default(0)
  preferredDifficulty String?
  errorPatterns       Json?
  commonMistakes      Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model QuestionScore {
  id               String   @id @default(cuid())
  answerId         String   @unique
  basePoints       Int
  difficulty       String
  timeBonus        Float
  streakMultiplier Float
  totalPoints      Int
  isFromIncomplete Boolean  @default(false)
  pointAdjustment  Float    @default(1.0)
  adjustmentReason String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  answer           Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)

  @@index([answerId])
}

model StatusEvent {
  id                  String      @id @default(cuid())
  sessionId           String
  eventType           String
  reason              String?
  questionIndex       Int?
  questionsAnswered   Int?
  questionsSkipped    Int?
  questionsUnanswered Int?
  attemptNumber       Int?
  timeSinceStart      Int?
  createdAt           DateTime    @default(now())
  session             TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventType])
  @@index([createdAt])
}

model TestPolicy {
  id                         String             @id @default(cuid())
  resumeWindowMinutes        Int                @default(15)
  maxResumeAttempts          Int                @default(3)
  inactivityTimeoutMin       Int                @default(30)
  scoreUnansweredAs          UnansweredHandling @default(SKIPPED)
  applyIncompletePenalty     Boolean            @default(false)
  incompletePenalty          Float              @default(0.9)
  includeUnansweredInMastery Boolean            @default(false)
  trackAbandonmentRate       Boolean            @default(true)
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
}

enum UserRole {
  STUDENT
  ADMIN
  INSTRUCTOR
}

enum TestMode {
  TUTOR
  TIMED
}

enum QuestionMode {
  STANDARD
  CUSTOM
  PRACTICE
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum AnswerStatus {
  CORRECT
  INCORRECT
  PARTIAL
  SKIPPED
  NOT_ANSWERED
  UNANSWERED
  TIMEOUT
  INCOMPLETE
  MARKED_REVIEW
}

enum TestStatus {
  ACTIVE
  PAUSED
  RESUMED
  COMPLETED
  ABANDONED
  TIMEOUT
  INCOMPLETE
}

enum AbandonReason {
  USER_QUIT
  NETWORK_ERROR
  BROWSER_CRASH
  AUTO_TIMEOUT
  SYSTEM_ERROR
}

enum UnansweredHandling {
  SKIPPED
  INCORRECT
  PENDING
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}
